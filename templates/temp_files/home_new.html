{% extends "base.html" %}

{% block title %}Dashboard - Kite Login App{% endblock %}
{% block header %}Kite Dashboard{% endblock %}

{% block content %}
<div class="status-info">
    <h3>âœ… Successfully Connected to Kite!</h3>
    <p><strong>Access Token:</strong> <code>{{ access_token[:20] }}...</code></p>
    <p>You are now authenticated and can use the Kite Connect API.</p>
</div>

<div style="text-align: center; margin: 30px 0;">
    <button onclick="loadProfile()" class="btn">Load Profile</button>
    <button onclick="loadHoldings()" class="btn btn-success">Load Holdings</button>
    <button onclick="loadPositions()" class="btn">Load Positions</button>
    <button onclick="loadMargins()" class="btn">Load Margins</button>
    <a href="{{ url_for('logout') }}" class="btn btn-danger">Logout</a>
</div>

<!-- Profile Section -->
<div id="profile-section" style="display: none;">
    <h3>User Profile</h3>
    <div id="profile-data"></div>
</div>

<!-- Holdings Section -->
<div id="holdings-section" style="display: none;">
    <h3>Holdings Portfolio</h3>
    <div id="holdings-summary" class="status-info" style="margin-bottom: 20px;"></div>
    <div id="holdings-data"></div>
</div>

<!-- Positions Section -->
<div id="positions-section" style="display: none;">
    <h3>Current Positions</h3>
    <div id="positions-summary" class="status-info" style="margin-bottom: 20px;"></div>
    <div id="positions-data"></div>
</div>

<!-- Margins Section -->
<div id="margins-section" style="display: none;">
    <h3>Margin Information</h3>
    <div id="margins-data"></div>
</div>

<script>
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-IN', {
        style: 'currency',
        currency: 'INR',
        minimumFractionDigits: 2
    }).format(amount);
}

function formatNumber(num) {
    return new Intl.NumberFormat('en-IN').format(num);
}

function loadProfile() {
    fetch('/profile')
        .then(response => response.json())
        .then(data => {
            const profileSection = document.getElementById('profile-section');
            const profileData = document.getElementById('profile-data');
            
            if (data.error) {
                profileData.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
            } else {
                profileData.innerHTML = `
                    <div class="status-info">
                        <p><strong>User ID:</strong> ${data.user_id}</p>
                        <p><strong>User Name:</strong> ${data.user_name}</p>
                        <p><strong>Email:</strong> ${data.email}</p>
                        <p><strong>Broker:</strong> ${data.broker}</p>
                        <p><strong>User Type:</strong> ${data.user_type}</p>
                        ${data.exchanges ? `<p><strong>Exchanges:</strong> ${data.exchanges.join(', ')}</p>` : ''}
                    </div>
                `;
            }
            
            profileSection.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('profile-data').innerHTML = 
                `<div class="alert alert-error">Error loading profile: ${error.message}</div>`;
            document.getElementById('profile-section').style.display = 'block';
        });
}

function loadHoldings() {
    fetch('/holdings')
        .then(response => response.json())
        .then(data => {
            const holdingsSection = document.getElementById('holdings-section');
            const holdingsSummary = document.getElementById('holdings-summary');
            const holdingsData = document.getElementById('holdings-data');
            
            if (data.error) {
                holdingsData.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
            } else if (data.length === 0) {
                holdingsData.innerHTML = `<div class="alert alert-error">No holdings found</div>`;
            } else {
                // Calculate summary
                let totalValue = 0;
                let totalInvestment = 0;
                let totalPnL = 0;
                
                data.forEach(holding => {
                    totalValue += (holding.last_price || 0) * (holding.quantity || 0);
                    totalInvestment += (holding.average_price || 0) * (holding.quantity || 0);
                    totalPnL += (holding.pnl || 0);
                });
                
                const pnlPercentage = totalInvestment > 0 ? ((totalPnL / totalInvestment) * 100) : 0;
                const pnlColor = totalPnL >= 0 ? 'green' : 'red';
                
                holdingsSummary.innerHTML = `
                    <h4>Portfolio Summary</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>Total Investment:</strong> ${formatCurrency(totalInvestment)}</div>
                        <div><strong>Current Value:</strong> ${formatCurrency(totalValue)}</div>
                        <div><strong>Total P&L:</strong> <span style="color: ${pnlColor};">${formatCurrency(totalPnL)} (${pnlPercentage.toFixed(2)}%)</span></div>
                        <div><strong>Holdings Count:</strong> ${data.length}</div>
                    </div>
                `;
                
                // Create holdings table
                let tableHTML = `
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead style="background-color: #f8f9fa;">
                            <tr>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Symbol</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Qty</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Avg Price</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">LTP</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Investment</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Current Value</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">P&L</th>
                                <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">P&L %</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                data.forEach(holding => {
                    const investment = (holding.average_price || 0) * (holding.quantity || 0);
                    const currentValue = (holding.last_price || 0) * (holding.quantity || 0);
                    const pnl = holding.pnl || 0;
                    const pnlPercent = investment > 0 ? ((pnl / investment) * 100) : 0;
                    const pnlColorRow = pnl >= 0 ? 'green' : 'red';
                    
                    tableHTML += `
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px;"><strong>${holding.tradingsymbol}</strong></td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatNumber(holding.quantity || 0)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatCurrency(holding.average_price || 0)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatCurrency(holding.last_price || 0)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatCurrency(investment)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatCurrency(currentValue)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: ${pnlColorRow};">${formatCurrency(pnl)}</td>
                            <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: ${pnlColorRow};">${pnlPercent.toFixed(2)}%</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                holdingsData.innerHTML = tableHTML;
            }
            
            holdingsSection.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('holdings-data').innerHTML = 
                `<div class="alert alert-error">Error loading holdings: ${error.message}</div>`;
            document.getElementById('holdings-section').style.display = 'block';
        });
}

function loadPositions() {
    fetch('/positions')
        .then(response => response.json())
        .then(data => {
            const positionsSection = document.getElementById('positions-section');
            const positionsSummary = document.getElementById('positions-summary');
            const positionsData = document.getElementById('positions-data');
            
            if (data.error) {
                positionsData.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
            } else {
                const netPositions = data.net || [];
                const dayPositions = data.day || [];
                
                if (netPositions.length === 0 && dayPositions.length === 0) {
                    positionsData.innerHTML = `<div class="alert alert-error">No positions found</div>`;
                } else {
                    // Calculate summary
                    let totalPnL = 0;
                    let totalRealizedPnL = 0;
                    let totalUnrealizedPnL = 0;
                    
                    netPositions.forEach(pos => {
                        totalPnL += (pos.pnl || 0);
                        totalRealizedPnL += (pos.realised || 0);
                        totalUnrealizedPnL += (pos.unrealised || 0);
                    });
                    
                    const pnlColor = totalPnL >= 0 ? 'green' : 'red';
                    
                    positionsSummary.innerHTML = `
                        <h4>Positions Summary</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div><strong>Total P&L:</strong> <span style="color: ${pnlColor};">${formatCurrency(totalPnL)}</span></div>
                            <div><strong>Realized P&L:</strong> <span style="color: ${totalRealizedPnL >= 0 ? 'green' : 'red'};">${formatCurrency(totalRealizedPnL)}</span></div>
                            <div><strong>Unrealized P&L:</strong> <span style="color: ${totalUnrealizedPnL >= 0 ? 'green' : 'red'};">${formatCurrency(totalUnrealizedPnL)}</span></div>
                            <div><strong>Open Positions:</strong> ${netPositions.length}</div>
                        </div>
                    `;
                    
                    let positionsHTML = '';
                    
                    if (netPositions.length > 0) {
                        positionsHTML += `
                            <h4>Net Positions</h4>
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                                <thead style="background-color: #f8f9fa;">
                                    <tr>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Symbol</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">Product</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Qty</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Avg Price</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">LTP</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">P&L</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Realized</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Unrealized</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        netPositions.forEach(pos => {
                            const pnl = pos.pnl || 0;
                            const realized = pos.realised || 0;
                            const unrealized = pos.unrealised || 0;
                            const pnlColorRow = pnl >= 0 ? 'green' : 'red';
                            
                            positionsHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>${pos.tradingsymbol}</strong></td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${pos.product}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatNumber(pos.quantity || 0)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatCurrency(pos.average_price || 0)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatCurrency(pos.last_price || 0)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: ${pnlColorRow};">${formatCurrency(pnl)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: ${realized >= 0 ? 'green' : 'red'};">${formatCurrency(realized)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: ${unrealized >= 0 ? 'green' : 'red'};">${formatCurrency(unrealized)}</td>
                                </tr>
                            `;
                        });
                        
                        positionsHTML += '</tbody></table>';
                    }
                    
                    if (dayPositions.length > 0) {
                        positionsHTML += `
                            <h4>Day Positions</h4>
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background-color: #f8f9fa;">
                                    <tr>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: left;">Symbol</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: center;">Product</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Buy Qty</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Sell Qty</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">Net Qty</th>
                                        <th style="border: 1px solid #ddd; padding: 12px; text-align: right;">P&L</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        dayPositions.forEach(pos => {
                            const pnl = pos.pnl || 0;
                            const pnlColorRow = pnl >= 0 ? 'green' : 'red';
                            
                            positionsHTML += `
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px;"><strong>${pos.tradingsymbol}</strong></td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: center;">${pos.product}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatNumber(pos.buy_quantity || 0)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatNumber(pos.sell_quantity || 0)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right;">${formatNumber(pos.quantity || 0)}</td>
                                    <td style="border: 1px solid #ddd; padding: 8px; text-align: right; color: ${pnlColorRow};">${formatCurrency(pnl)}</td>
                                </tr>
                            `;
                        });
                        
                        positionsHTML += '</tbody></table>';
                    }
                    
                    positionsData.innerHTML = positionsHTML;
                }
            }
            
            positionsSection.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('positions-data').innerHTML = 
                `<div class="alert alert-error">Error loading positions: ${error.message}</div>`;
            document.getElementById('positions-section').style.display = 'block';
        });
}

function loadMargins() {
    fetch('/margins')
        .then(response => response.json())
        .then(data => {
            const marginsSection = document.getElementById('margins-section');
            const marginsData = document.getElementById('margins-data');
            
            if (data.error) {
                marginsData.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
            } else if (data.equity || data.commodity) {
                let marginsHTML = '';
                
                if (data.equity) {
                    const equity = data.equity;
                    marginsHTML += `
                        <div class="status-info" style="margin-bottom: 20px;">
                            <h4>Equity Segment</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div><strong>Available Cash:</strong> ${formatCurrency(equity.available?.cash || 0)}</div>
                                <div><strong>Opening Balance:</strong> ${formatCurrency(equity.available?.opening_balance || 0)}</div>
                                <div><strong>Live Balance:</strong> ${formatCurrency(equity.available?.live_balance || 0)}</div>
                                <div><strong>Adhoc Margin:</strong> ${formatCurrency(equity.available?.adhoc_margin || 0)}</div>
                                <div><strong>Collateral:</strong> ${formatCurrency(equity.available?.collateral || 0)}</div>
                                <div><strong>Intraday Payin:</strong> ${formatCurrency(equity.available?.intraday_payin || 0)}</div>
                            </div>
                        </div>
                        <div class="status-info" style="margin-bottom: 20px;">
                            <h5>Utilised Margins</h5>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                <div><strong>Debits:</strong> ${formatCurrency(equity.utilised?.debits || 0)}</div>
                                <div><strong>Exposure:</strong> ${formatCurrency(equity.utilised?.exposure || 0)}</div>
                                <div><strong>M2M Realised:</strong> ${formatCurrency(equity.utilised?.m2m_realised || 0)}</div>
                                <div><strong>M2M Unrealised:</strong> ${formatCurrency(equity.utilised?.m2m_unrealised || 0)}</div>
                                <div><strong>Option Premium:</strong> ${formatCurrency(equity.utilised?.option_premium || 0)}</div>
                                <div><strong>Payout:</strong> ${formatCurrency(equity.utilised?.payout || 0)}</div>
                                <div><strong>Span:</strong> ${formatCurrency(equity.utilised?.span || 0)}</div>
                                <div><strong>Holding Sales:</strong> ${formatCurrency(equity.utilised?.holding_sales || 0)}</div>
                                <div><strong>Turnover:</strong> ${formatCurrency(equity.utilised?.turnover || 0)}</div>
                            </div>
                        </div>
                    `;
                }
                
                if (data.commodity) {
                    const commodity = data.commodity;
                    marginsHTML += `
                        <div class="status-info" style="margin-bottom: 20px;">
                            <h4>Commodity Segment</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div><strong>Available Cash:</strong> ${formatCurrency(commodity.available?.cash || 0)}</div>
                                <div><strong>Opening Balance:</strong> ${formatCurrency(commodity.available?.opening_balance || 0)}</div>
                                <div><strong>Live Balance:</strong> ${formatCurrency(commodity.available?.live_balance || 0)}</div>
                                <div><strong>Adhoc Margin:</strong> ${formatCurrency(commodity.available?.adhoc_margin || 0)}</div>
                                <div><strong>Collateral:</strong> ${formatCurrency(commodity.available?.collateral || 0)}</div>
                                <div><strong>Intraday Payin:</strong> ${formatCurrency(commodity.available?.intraday_payin || 0)}</div>
                            </div>
                        </div>
                    `;
                }
                
                marginsData.innerHTML = marginsHTML;
            } else {
                marginsData.innerHTML = `<div class="alert alert-error">No margin data available</div>`;
            }
            
            marginsSection.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('margins-data').innerHTML = 
                `<div class="alert alert-error">Error loading margins: ${error.message}</div>`;
            document.getElementById('margins-section').style.display = 'block';
        });
}
</script>

<div style="margin-top: 40px;">
    <h3>Next Steps</h3>
    <p>Now that you're authenticated, you can:</p>
    <ul>
        <li>View your holdings and current positions</li>
        <li>Check margin details and available funds</li>
        <li>Use the Kite API wrapper to place orders and manage trades</li>
        <li>Extend this application with more trading features</li>
    </ul>
    
    <p><strong>Note:</strong> The access token is valid until market close. You'll need to re-authenticate daily.</p>
</div>
{% endblock %}
                