<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Kite Login App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e53 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .content {
            padding: 30px;
        }

        .status-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .status-info h3 {
            font-size: 1.5rem;
            margin-bottom: 15px;
        }

        .status-info code {
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
        }

        .btn-container {
            text-align: center;
            margin: 30px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }

        .section {
            margin: 30px 0;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            display: none;
        }

        .section h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8rem;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f1aeb5;
            color: #721c24;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            border: 1px solid #e9ecef;
            padding: 12px;
            background: white;
        }

        tbody tr:hover {
            background: #f8f9fa;
            transition: background 0.2s ease;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .summary-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .next-steps {
            margin-top: 40px;
            padding: 25px;
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-radius: 15px;
        }

        .next-steps h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .next-steps ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .next-steps li {
            margin-bottom: 8px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .btn-container {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 Kite Dashboard</h1>
        </div>
        
        <div class="content">
            <div class="status-info">
                <h3>✅ Successfully Connected to Kite!</h3>
                <p><strong>Access Token:</strong> <code id="access-token">Loading...</code></p>
                <p>You are now authenticated and can use the Kite Connect API.</p>
            </div>

            <div class="btn-container">
                <button onclick="loadProfile()" class="btn">📊 Load Profile</button>
                <button onclick="loadHoldings()" class="btn btn-success">💼 Load Holdings</button>
                <button onclick="loadPositions()" class="btn">📈 Load Positions</button>
                <button onclick="loadMargins()" class="btn">💰 Load Margins</button>
                <a href="/logout" class="btn btn-danger">🚪 Logout</a>
            </div>

            <!-- Profile Section -->
            <div id="profile-section" class="section">
                <h3>👤 User Profile</h3>
                <div id="profile-data"></div>
            </div>

            <!-- Holdings Section -->
            <div id="holdings-section" class="section">
                <h3>📊 Holdings Portfolio</h3>
                <div id="holdings-summary" class="status-info"></div>
                <div id="holdings-data"></div>
            </div>

            <!-- Positions Section -->
            <div id="positions-section" class="section">
                <h3>📈 Current Positions</h3>
                <div id="positions-summary" class="status-info"></div>
                <div id="positions-data"></div>
            </div>

            <!-- Margins Section -->
            <div id="margins-section" class="section">
                <h3>💰 Margin Information</h3>
                <div id="margins-data"></div>
            </div>

            <div class="next-steps">
                <h3>🎯 Next Steps</h3>
                <p>Now that you're authenticated, you can:</p>
                <ul>
                    <li>View your holdings and current positions</li>
                    <li>Check margin details and available funds</li>
                    <li>Use the Kite API wrapper to place orders and manage trades</li>
                    <li>Extend this application with more trading features</li>
                </ul>
                
                <p><strong>Note:</strong> The access token is valid until market close. You'll need to re-authenticate daily.</p>
            </div>
        </div>
    </div>

    <script>
        // Initialize access token display
        document.addEventListener('DOMContentLoaded', function() {
            // You can set this from your Flask template or via an API call
            const accessToken = "{{ access_token }}"; // This will be replaced by Flask
            if (accessToken && accessToken !== "{{ access_token }}") {
                document.getElementById('access-token').textContent = accessToken.substring(0, 20) + '...';
            }
        });

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2
            }).format(amount);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }

        function showSection(sectionId) {
            document.getElementById(sectionId).style.display = 'block';
        }

        function loadProfile() {
            fetch('/profile')
                .then(response => response.json())
                .then(data => {
                    const profileData = document.getElementById('profile-data');
                    
                    if (data.error) {
                        profileData.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
                    } else {
                        profileData.innerHTML = `
                            <div class="summary-grid">
                                <div class="summary-item"><strong>User ID:</strong> ${data.user_id}</div>
                                <div class="summary-item"><strong>User Name:</strong> ${data.user_name}</div>
                                <div class="summary-item"><strong>Email:</strong> ${data.email}</div>
                                <div class="summary-item"><strong>Broker:</strong> ${data.broker}</div>
                                <div class="summary-item"><strong>User Type:</strong> ${data.user_type}</div>
                                ${data.exchanges ? `<div class="summary-item"><strong>Exchanges:</strong> ${data.exchanges.join(', ')}</div>` : ''}
                            </div>
                        `;
                    }
                    
                    showSection('profile-section');
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('profile-data').innerHTML = 
                        `<div class="alert alert-error">Error loading profile: ${error.message}</div>`;
                    showSection('profile-section');
                });
        }

        function loadHoldings() {
            fetch('/holdings')
                .then(response => response.json())
                .then(data => {
                    const holdingsSummary = document.getElementById('holdings-summary');
                    const holdingsData = document.getElementById('holdings-data');
                    
                    if (data.error) {
                        holdingsData.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
                    } else if (data.length === 0) {
                        holdingsData.innerHTML = `<div class="alert alert-error">No holdings found</div>`;
                    } else {
                        // Calculate summary
                        let totalValue = 0;
                        let totalInvestment = 0;
                        let totalPnL = 0;
                        
                        data.forEach(holding => {
                            totalValue += (holding.last_price || 0) * (holding.quantity || 0);
                            totalInvestment += (holding.average_price || 0) * (holding.quantity || 0);
                            totalPnL += (holding.pnl || 0);
                        });
                        
                        const pnlPercentage = totalInvestment > 0 ? ((totalPnL / totalInvestment) * 100) : 0;
                        const pnlColor = totalPnL >= 0 ? 'green' : 'red';
                        
                        holdingsSummary.innerHTML = `
                            <h4>📊 Portfolio Summary</h4>
                            <div class="summary-grid">
                                <div class="summary-item"><strong>Total Investment:</strong> ${formatCurrency(totalInvestment)}</div>
                                <div class="summary-item"><strong>Current Value:</strong> ${formatCurrency(totalValue)}</div>
                                <div class="summary-item"><strong>Total P&L:</strong> <span style="color: ${pnlColor};">${formatCurrency(totalPnL)} (${pnlPercentage.toFixed(2)}%)</span></div>
                                <div class="summary-item"><strong>Holdings Count:</strong> ${data.length}</div>
                            </div>
                        `;
                        
                        // Create holdings table
                        let tableHTML = `
                            <table>
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th style="text-align: right;">Qty</th>
                                        <th style="text-align: right;">Avg Price</th>
                                        <th style="text-align: right;">LTP</th>
                                        <th style="text-align: right;">Investment</th>
                                        <th style="text-align: right;">Current Value</th>
                                        <th style="text-align: right;">P&L</th>
                                        <th style="text-align: right;">P&L %</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        data.forEach(holding => {
                            const investment = (holding.average_price || 0) * (holding.quantity || 0);
                            const currentValue = (holding.last_price || 0) * (holding.quantity || 0);
                            const pnl = holding.pnl || 0;
                            const pnlPercent = investment > 0 ? ((pnl / investment) * 100) : 0;
                            const pnlColorRow = pnl >= 0 ? 'green' : 'red';
                            
                            tableHTML += `
                                <tr>
                                    <td><strong>${holding.tradingsymbol}</strong></td>
                                    <td style="text-align: right;">${formatNumber(holding.quantity || 0)}</td>
                                    <td style="text-align: right;">${formatCurrency(holding.average_price || 0)}</td>
                                    <td style="text-align: right;">${formatCurrency(holding.last_price || 0)}</td>
                                    <td style="text-align: right;">${formatCurrency(investment)}</td>
                                    <td style="text-align: right;">${formatCurrency(currentValue)}</td>
                                    <td style="text-align: right; color: ${pnlColorRow}; font-weight: bold;">${formatCurrency(pnl)}</td>
                                    <td style="text-align: right; color: ${pnlColorRow}; font-weight: bold;">${pnlPercent.toFixed(2)}%</td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += '</tbody></table>';
                        holdingsData.innerHTML = tableHTML;
                    }
                    
                    showSection('holdings-section');
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('holdings-data').innerHTML = 
                        `<div class="alert alert-error">Error loading holdings: ${error.message}</div>`;
                    showSection('holdings-section');
                });
        }

        function loadPositions() {
            fetch('/positions')
                .then(response => response.json())
                .then(data => {
                    const positionsSummary = document.getElementById('positions-summary');
                    const positionsData = document.getElementById('positions-data');
                    
                    if (data.error) {
                        positionsData.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
                    } else {
                        const netPositions = data.net || [];
                        const dayPositions = data.day || [];
                        
                        if (netPositions.length === 0 && dayPositions.length === 0) {
                            positionsData.innerHTML = `<div class="alert alert-error">No positions found</div>`;
                        } else {
                            // Calculate summary
                            let totalPnL = 0;
                            let totalRealizedPnL = 0;
                            let totalUnrealizedPnL = 0;
                            
                            netPositions.forEach(pos => {
                                totalPnL += (pos.pnl || 0);
                                totalRealizedPnL += (pos.realised || 0);
                                totalUnrealizedPnL += (pos.unrealised || 0);
                            });
                            
                            const pnlColor = totalPnL >= 0 ? 'green' : 'red';
                            
                            positionsSummary.innerHTML = `
                                <h4>📈 Positions Summary</h4>
                                <div class="summary-grid">
                                    <div class="summary-item"><strong>Total P&L:</strong> <span style="color: ${pnlColor}; font-weight: bold;">${formatCurrency(totalPnL)}</span></div>
                                    <div class="summary-item"><strong>Realized P&L:</strong> <span style="color: ${totalRealizedPnL >= 0 ? 'green' : 'red'}; font-weight: bold;">${formatCurrency(totalRealizedPnL)}</span></div>
                                    <div class="summary-item"><strong>Unrealized P&L:</strong> <span style="color: ${totalUnrealizedPnL >= 0 ? 'green' : 'red'}; font-weight: bold;">${formatCurrency(totalUnrealizedPnL)}</span></div>
                                    <div class="summary-item"><strong>Open Positions:</strong> ${netPositions.length}</div>
                                </div>
                            `;
                            
                            let positionsHTML = '';
                            
                            if (netPositions.length > 0) {
                                positionsHTML += `
                                    <h4>📊 Net Positions</h4>
                                    <table style="margin-bottom: 30px;">
                                        <thead>
                                            <tr>
                                                <th>Symbol</th>
                                                <th style="text-align: center;">Product</th>
                                                <th style="text-align: right;">Qty</th>
                                                <th style="text-align: right;">Avg Price</th>
                                                <th style="text-align: right;">LTP</th>
                                                <th style="text-align: right;">P&L</th>
                                                <th style="text-align: right;">Realized</th>
                                                <th style="text-align: right;">Unrealized</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                `;
                                
                                netPositions.forEach(pos => {
                                    const pnl = pos.pnl || 0;
                                    const realized = pos.realised || 0;
                                    const unrealized = pos.unrealised || 0;
                                    const pnlColorRow = pnl >= 0 ? 'green' : 'red';
                                    
                                    positionsHTML += `
                                        <tr>
                                            <td><strong>${pos.tradingsymbol}</strong></td>
                                            <td style="text-align: center;">${pos.product}</td>
                                            <td style="text-align: right;">${formatNumber(pos.quantity || 0)}</td>
                                            <td style="text-align: right;">${formatCurrency(pos.average_price || 0)}</td>
                                            <td style="text-align: right;">${formatCurrency(pos.last_price || 0)}</td>
                                            <td style="text-align: right; color: ${pnlColorRow}; font-weight: bold;">${formatCurrency(pnl)}</td>
                                            <td style="text-align: right; color: ${realized >= 0 ? 'green' : 'red'}; font-weight: bold;">${formatCurrency(realized)}</td>
                                            <td style="text-align: right; color: ${unrealized >= 0 ? 'green' : 'red'}; font-weight: bold;">${formatCurrency(unrealized)}</td>
                                        </tr>
                                    `;
                                });
                                
                                positionsHTML += '</tbody></table>';
                            }
                            
                            if (dayPositions.length > 0) {
                                positionsHTML += `
                                    <h4>📅 Day Positions</h4>
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Symbol</th>
                                                <th style="text-align: center;">Product</th>
                                                <th style="text-align: right;">Buy Qty</th>
                                                <th style="text-align: right;">Sell Qty</th>
                                                <th style="text-align: right;">Net Qty</th>
                                                <th style="text-align: right;">P&L</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                `;
                                
                                dayPositions.forEach(pos => {
                                    const pnl = pos.pnl || 0;
                                    const pnlColorRow = pnl >= 0 ? 'green' : 'red';
                                    
                                    positionsHTML += `
                                        <tr>
                                            <td><strong>${pos.tradingsymbol}</strong></td>
                                            <td style="text-align: center;">${pos.product}</td>
                                            <td style="text-align: right;">${formatNumber(pos.buy_quantity || 0)}</td>
                                            <td style="text-align: right;">${formatNumber(pos.sell_quantity || 0)}</td>
                                            <td style="text-align: right;">${formatNumber(pos.quantity || 0)}</td>
                                            <td style="text-align: right; color: ${pnlColorRow}; font-weight: bold;">${formatCurrency(pnl)}</td>
                                        </tr>
                                    `;
                                });
                                
                                positionsHTML += '</tbody></table>';
                            }
                            
                            positionsData.innerHTML = positionsHTML;
                        }
                    }
                    
                    showSection('positions-section');
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('positions-data').innerHTML = 
                        `<div class="alert alert-error">Error loading positions: ${error.message}</div>`;
                    showSection('positions-section');
                });
        }

        function loadMargins() {
            fetch('/margins')
                .then(response => response.json())
                .then(data => {
                    const marginsData = document.getElementById('margins-data');
                    
                    if (data.error) {
                        marginsData.innerHTML = `<div class="alert alert-error">Error: ${data.error}</div>`;
                    } else if (data.equity || data.commodity) {
                        let marginsHTML = '';
                        
                        if (data.equity) {
                            const equity = data.equity;
                            marginsHTML += `
                                <div class="summary-item" style="margin-bottom: 20px; padding: 20px;">
                                    <h4>💼 Equity Segment</h4>
                                    <div class="summary-grid">
                                        <div class="summary-item"><strong>Available Cash:</strong> ${formatCurrency(equity.available?.cash || 0)}</div>
                                        <div class="summary-item"><strong>Opening Balance:</strong> ${formatCurrency(equity.available?.opening_balance || 0)}</div>
                                        <div class="summary-item"><strong>Live Balance:</strong> ${formatCurrency(equity.available?.live_balance || 0)}</div>
                                        <div class="summary-item"><strong>Adhoc Margin:</strong> ${formatCurrency(equity.available?.adhoc_margin || 0)}</div>
                                        <div class="summary-item"><strong>Collateral:</strong> ${formatCurrency(equity.available?.collateral || 0)}</div>
                                        <div class="summary-item"><strong>Intraday Payin:</strong> ${formatCurrency(equity.available?.intraday_payin || 0)}</div>
                                    </div>
                                </div>
                                <div class="summary-item" style="margin-bottom: 20px; padding: 20px;">
                                    <h5>📊 Utilised Margins</h5>
                                    <div class="summary-grid">
                                        <div class="summary-item"><strong>Debits:</strong> ${formatCurrency(equity.utilised?.debits || 0)}</div>
                                        <div class="summary-item"><strong>Exposure:</strong> ${formatCurrency(equity.utilised?.exposure || 0)}</div>
                                        <div class="summary-item"><strong>M2M Realised:</strong> ${formatCurrency(equity.utilised?.m2m_realised || 0)}</div>
                                        <div class="summary-item"><strong>M2M Unrealised:</strong> ${formatCurrency(equity.utilised?.m2m_unrealised || 0)}</div>
                                        <div class="summary-item"><strong>Option Premium:</strong> ${formatCurrency(equity.utilised?.option_premium || 0)}</div>
                                        <div class="summary-item"><strong>Payout:</strong> ${formatCurrency(equity.utilised?.payout || 0)}</div>
                                        <div class="summary-item"><strong>Span:</strong> ${formatCurrency(equity.utilised?.span || 0)}</div>
                                        <div class="summary-item"><strong>Holding Sales:</strong> ${formatCurrency(equity.utilised?.holding_sales || 0)}</div>
                                        <div class="summary-item"><strong>Turnover:</strong> ${formatCurrency(equity.utilised?.turnover || 0)}</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        if (data.commodity) {
                            const commodity = data.commodity;
                            marginsHTML += `
                                <div class="summary-item" style="margin-bottom: 20px; padding: 20px;">
                                    <h4>🏭 Commodity Segment</h4>
                                    <div class="summary-grid">
                                        <div class="summary-item"><strong>Available Cash:</strong> ${formatCurrency(commodity.available?.cash || 0)}</div>
                                        <div class="summary-item"><strong>Opening Balance:</strong> ${formatCurrency(commodity.available?.opening_balance || 0)}</div>
                                        <div class="summary-item"><strong>Live Balance:</strong> ${formatCurrency(commodity.available?.live_balance || 0)}</div>
                                        <div class="summary-item"><strong>Adhoc Margin:</strong> ${formatCurrency(commodity.available?.adhoc_margin || 0)}</div>
                                        <div class="summary-item"><strong>Collateral:</strong> ${formatCurrency(commodity.available?.collateral || 0)}</div>
                                        <div class="summary-item"><strong>Intraday Payin:</strong> ${formatCurrency(commodity.available?.intraday_payin || 0)}</div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        marginsData.innerHTML = marginsHTML;
                    } else {
                        marginsData.innerHTML = `<div class="alert alert-error">No margin data available</div>`;
                    }
                    
                    showSection('margins-section');
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('margins-data').innerHTML = 
                        `<div class="alert alert-error">Error loading margins: ${error.message}</div>`;
                    showSection('margins-section');
                });
        }
    </script>
</body>
</html>